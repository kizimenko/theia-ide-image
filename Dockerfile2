FROM python:3.7-alpine3.9

ARG GITHUB_TOKEN

ENV RST_UID=472 \ 
    RST_GID=472 \
    WORKSPACE_PATH=/home/theia/project \
    BUILD_PATH=/home/theia/.build \
    PYENV=.py3env \
    PATH=/usr/local/bin:$PATH \
    LANG=C.UTF-8


RUN apk add --no-cache ca-certificates \
    make gcc g++ coreutils \
    nodejs~=10 nodejs-dev~=10 yarn \
    gzip curl nano jq \
    git openssh-client \
    su-exec sudo \
    zsh

WORKDIR /home/theia

RUN echo "theia ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers.d/default \
    && chmod 0440 /etc/sudoers.d/default \
    && addgroup -g ${RST_GID} theia \
    && adduser -u ${RST_UID} -G theia -s /bin/sh -D theia \
    && chmod g+rw /home/theia \
    && mkdir -p ${HOME}/.build ${HOME}/project  \
    && chown -R theia:theia /home/theia

RUN yarn global add node-gyp

USER theia

ENV PORT_THEIA=${PORT_THEIA:-8000} \
    PORT=${PORT_DEV:-8080} \
    SHELL=/bin/zsh \
    USE_LOCAL_GIT=true \
    VIRTUAL_ENV_DISABLE_PROMPT=yes

COPY --chown=theia:theia requirements.txt .editorconfig init_zprezto ${BUILD_PATH}/

RUN git clone --recursive https://github.com/sorin-ionescu/prezto.git $HOME/.zprezto \ 
    && ${BUILD_PATH}/init_zprezto 


LABEL band.images.theia.version="1.0.0"
ARG PY_REQUIREMENTS
RUN echo "${PY_REQUIREMENTS:-none}" \
    && python3 -m venv $PYENV  \
    && source $PYENV/bin/activate \
    && pip install -U git+https://github.com/rockstat/band@master#egg=band \
    && pip install -U -r ${BUILD_PATH}/requirements.txt

# COPY --chown=theia:theia package .build/package

COPY --chown=theia:theia package/package.json ./.build

RUN cd ${BUILD_PATH} && yarn --cache-folder ./ycache && rm -rf ./ycache
RUN cd ${BUILD_PATH} && yarn theia build

# RUN cd ${BUILD_PATH} \
#     && git clone https://github.com/madiedinro/theia.git theia \
    # && cd theia \
    # && rm -rf examples/* \
#     && mv ${BUILD_PATH}/package ./examples \
#     && yarn

# RUN cd ${BUILD_PATH}/theia/examples/package \
#     && yarn run clean \
#     && yarn theia build

COPY --chown=theia:theia init_app ./.build/
COPY --chown=theia:theia .theia/settings.json .theia/tasks.json .theia/tasks.json-tmpl ./.build/.theia/

EXPOSE 8080 8000

CMD ${BUILD_PATH}/init_app
